<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รายงานสรุปผลการเรียนรายบุคคล</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
      .loading { border-top-color: #3498db; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
      @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      
      @media (max-width: 768px) {
        .responsive-table thead { display: none; }
        .responsive-table tr { 
          display: block; 
          margin-bottom: 1.5rem; 
          border: 1px solid #e5e7eb; 
          border-radius: 0.75rem; 
          background: white; 
          padding: 1.25rem;
          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .responsive-table td { 
          display: flex; 
          justify-content: space-between; 
          align-items: center; 
          border-bottom: 1px solid #f3f4f6; 
          padding: 0.75rem 0; 
        }
        .responsive-table td:last-child { border-bottom: 0; }
        .responsive-table td::before { 
          content: attr(data-label); 
          font-weight: 600; 
          color: #4b5563; 
          text-align: left;
          width: 40%;
        }
        .responsive-table td span { 
          text-align: right; 
          width: 60%; 
          word-break: break-word;
          color: #1f2937;
        }
        .responsive-table td:first-child {
          background-color: #eff6ff;
          margin: -1.25rem -1.25rem 0.75rem -1.25rem;
          padding: 1rem 1.25rem;
          border-bottom: 1px solid #dbeafe;
          border-radius: 0.75rem 0.75rem 0 0;
          color: #1d4ed8;
          font-weight: bold;
        }
      }
    </style>
  </head>
  <body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden">
      <!-- Header -->
      <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-6 text-white shadow-md">
        <h1 class="text-2xl md:text-3xl font-bold text-center">ระบบรายงานสรุปผลรายบุคคล</h1>
      </div>

      <!-- Search Section -->
      <div class="p-6 border-b border-gray-200 bg-gray-50">
        <div class="flex flex-col md:flex-row justify-center items-center gap-4 max-w-4xl mx-auto">
          <label for="nameSelect" class="font-semibold text-gray-700 whitespace-nowrap">เลือกรายชื่อ:</label>
          <div class="relative w-full md:w-2/3">
            <select id="nameSelect" class="block w-full p-3 pl-4 pr-10 text-base text-gray-700 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 shadow-sm appearance-none">
              <option value="" disabled selected>กำลังโหลดรายชื่อ...</option>
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
              <svg class="fill-current h-5 w-5" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
            </div>
          </div>
          <button onclick="fetchData()" class="w-full md:w-auto px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 flex items-center justify-center gap-2">
            ค้นหา
          </button>
        </div>
      </div>

      <!-- Result Area -->
      <div id="resultArea" class="p-6 hidden bg-white">
        
        <!-- Loading -->
        <div id="loading" class="hidden flex flex-col justify-center items-center py-12">
          <div class="loading ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
          <p class="text-gray-500 text-sm">กำลังดึงข้อมูล...</p>
        </div>

        <!-- NEW: Summary Data Section (B:H) -->
        <div id="summarySection" class="mb-8 hidden animate-fade-in">
           <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2 border-b pb-2">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
             </svg>
             ข้อมูลสรุป
           </h3>
           <div id="summaryGrid" class="flex flex-col bg-white rounded-lg border border-gray-200 divide-y divide-gray-100 shadow-sm max-w-3xl mx-auto">
              <!-- Summary Items injected here -->
           </div>
           
           <hr class="my-6 border-gray-200">
        </div>

        <!-- Title Section -->
        <div id="contentSection" class="hidden">
            <div class="flex items-center gap-3 mb-6">
               <div class="h-8 w-1 bg-blue-500 rounded-full"></div>
               <h2 id="resultTitle" class="text-xl font-bold text-gray-800"></h2>
            </div>

            <!-- Table -->
            <div id="tableContainer" class="overflow-x-auto rounded-lg"></div>
        </div>
      </div>
    </div>

    <footer class="text-center text-gray-400 text-sm mt-8 pb-8">&copy; ระบบรายงานข้อมูลรายบุคคล</footer>

    <script>
      // *** URL ของ Web App ***
      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyuimNbVUmCyqvHJNVR-rFzbi_t2OxK_Gl3WV_CWGIG7sXBf2y9iOvZgtYb-PF3gs4gtQ/exec';

      window.onload = function() {
        fetch(SCRIPT_URL + '?action=getNames')
          .then(response => response.json())
          .then(names => populateNames(names))
          .catch(error => handleError(error));
      };

      function populateNames(names) {
        var select = document.getElementById("nameSelect");
        select.innerHTML = '<option value="" disabled selected>-- เลือกรายชื่อ --</option>';
        names.forEach(function(name) {
          var option = document.createElement("option");
          option.value = name;
          option.text = name;
          select.appendChild(option);
        });
      }

      function fetchData() {
        var select = document.getElementById("nameSelect");
        var name = select.value;
        
        if (!name) {
          alert("กรุณาเลือกรายชื่อก่อนครับ");
          return;
        }

        document.getElementById("resultArea").classList.remove("hidden");
        document.getElementById("summarySection").classList.add("hidden");
        document.getElementById("contentSection").classList.add("hidden");
        document.getElementById("loading").classList.remove("hidden");
        
        document.getElementById("resultTitle").textContent = "ข้อมูลการเรียนของ: " + name;

        fetch(SCRIPT_URL + '?action=getData&name=' + encodeURIComponent(name))
          .then(response => response.json())
          .then(data => renderResult(data))
          .catch(error => handleError(error));
      }

      function renderResult(response) {
        document.getElementById("loading").classList.add("hidden");
        document.getElementById("contentSection").classList.remove("hidden");

        // 1. Render Summary (B:H)
        if (response.summary && response.summary.length > 0) {
           var summaryGrid = document.getElementById("summaryGrid");
           summaryGrid.innerHTML = "";
           
           // รายชื่อหัวข้อที่ต้องการแสดงตามลำดับ Col B ถึง H (ครบ 7 รายการ)
           var fixedLabels = [
             "ชั่วโมงเรียนสะสม",
             "ชั่วโมงลาสะสม",
             "ขาดเรียนสะสม",
             "ลาและขาดสะสม",
             "%การลาและขาดเรียน",
             "ลาป่วยสะสม",
             "ลากิจสะสม"
           ];

           // Loop ตามจำนวน label ที่ตั้งไว้ (7 ครั้ง)
           fixedLabels.forEach((label, index) => {
             // ดึงค่าจาก response.summary ตาม index
             var item = response.summary[index] || {};
             var value = item.value || "-";

             var rowHTML = `
               <div class="flex justify-between items-center py-2 px-4 hover:bg-gray-50 transition-colors">
                 <div class="text-gray-700 font-medium">${label}</div>
                 <div class="text-blue-700 font-bold text-base text-right pl-4">${value}</div>
               </div>
             `;
             summaryGrid.innerHTML += rowHTML;
           });
           
           document.getElementById("summarySection").classList.remove("hidden");
        }

        // 2. Render Table Details (N...)
        renderTable(response.details);
      }

      function renderTable(data) {
        var container = document.getElementById("tableContainer");
        
        if (!data || data.length === 0) {
          container.innerHTML = `
            <div class="flex flex-col items-center justify-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                <p class="text-gray-500 text-lg">ไม่พบข้อมูลรายละเอียดการเข้าเรียน</p>
            </div>`;
          return;
        }

        var fixedHeaders = [
            "วันที่", "เวลาเข้าเรียน", "ลาตั้งแต่", "ลาถึง", "สาเหตุ", 
            "ชั่วโมงเรียนตลอดวัน", "ชั่วโมงลาตามจริง", "ขาดเรียน", 
            "ชั่วโมงเรียนสะสม", "ชั่วโมงลาสะสม", "ขาดเรียนสะสม", 
            "%การลาและขาดเรียน", "หมายเหตุ"
        ];

        var tableHTML = '<table class="min-w-full leading-normal responsive-table border-collapse">';
        
        tableHTML += '<thead><tr class="bg-gray-100 text-gray-700 uppercase text-sm leading-normal border-b-2 border-gray-300">';
        fixedHeaders.forEach(function(header, index) {
            var styleClass = index === 0 ? "py-4 px-6 text-left font-bold w-32 bg-gray-200" : "py-3 px-4 text-left font-semibold tracking-wider";
            tableHTML += `<th class="${styleClass}">${header}</th>`;
        });
        tableHTML += '</tr></thead>';

        tableHTML += '<tbody class="text-gray-700 text-sm">';
        data.forEach(function(row, index) {
          var bgClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
          tableHTML += `<tr class="border-b border-gray-200 hover:bg-blue-50 transition duration-150 ${bgClass}">`;
          
          var rowLabel = (row.headers && row.headers[0]) ? row.headers[0] : ("ชุดที่ " + row.blockIndex);
          tableHTML += `<td class="py-4 px-6 text-left font-bold text-blue-700 whitespace-nowrap border-r border-gray-100" data-label="${fixedHeaders[0]}">${rowLabel}</td>`;
          
          row.values.forEach(function(val, i) {
             var label = fixedHeaders[i+1] || ('ข้อมูล ' + (i+1));
             var displayVal = val === "" ? "-" : val;
             var textClass = val === "" ? "text-gray-300" : "";
             tableHTML += `<td class="py-3 px-4 text-left ${textClass}" data-label="${label}"><span>${displayVal}</span></td>`;
          });
          tableHTML += '</tr>';
        });

        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
      }

      function handleError(error) {
        document.getElementById("loading").classList.add("hidden");
        console.error("Error:", error);
        alert("เกิดข้อผิดพลาด: " + error.message);
      }
    </script>
  </body>
</html>
